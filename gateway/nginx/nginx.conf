worker_processes auto;

events {
    worker_connections 4096;
}

http {
    include /etc/nginx/mime.types;
    sendfile on;

    gzip on;
    gzip_comp_level 4;
    gzip_types text/plain text/css application/json application/javascript;

    # ========= UPSTREAM SERVICES ==========
    upstream academy_service       { server academy_service:8080; }
    upstream attendance_service    { server attendance_service:8080; }
    upstream connect_service       { server connect_service:8080; }
    upstream identity_service      { server identity_service:8080; }
    upstream payment_service       { server payment_service:8080; }
    upstream payroll_service       { server payroll_service:8080; }
    upstream rule_engine           { server rule_engine:8080; }
    upstream ai_gateway            { server ai_gateway:8080; }
    upstream frontend              { server frontend:3000; }

    server {
        listen 80;
        server_name _;

        # ========= GLOBAL CORS ==========
        add_header Access-Control-Allow-Origin * always;
        add_header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS" always;
        add_header Access-Control-Allow-Headers "Authorization, Content-Type" always;
        add_header Access-Control-Allow-Credentials true always;

        if ($request_method = OPTIONS) {
            return 204;
        }

        # ========= API ROUTING ==========
        location /api/academy/      { proxy_pass http://academy_service/; }
        location /api/attendance/   { proxy_pass http://attendance_service/; }
        location /api/connect/      { proxy_pass http://connect_service/; }
        location /api/identity/     { proxy_pass http://identity_service/; }
        location /api/payment/      { proxy_pass http://payment_service/; }
        location /api/payroll/      { proxy_pass http://payroll_service/; }
        location /api/rule/         { proxy_pass http://rule_engine/; }
        location /api/ai/           { proxy_pass http://ai_gateway/; }

        # ========= FRONTEND FALLBACK ==========
        location / {
            proxy_pass http://frontend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }
    }
}
